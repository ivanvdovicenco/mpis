# Техническое задание (ТЗ)

## Multi-Persona Intelligence System (MPIS) / Multi-Persona Intelligence System (MPIS)

**Версия:** 3.0 (консолидированная спецификация)
**Назначение документа:** единый «технический паспорт» + ТЗ на разработку MPIS, включая модули, данные, API, безопасность, деплой и требования к визуальному Dashboard (в т.ч. как графической платформе создания личностей).

---

## 1) Концепция и философия системы

**MPIS** — self-hosted экосистема для создания, развития и анализа множества цифровых личностей (personas).
Каждая личность — **осмысленная сущность**, основанная на конкретной идее/авторе/мировоззрении/культурном коде и обладающая:

1. **Credo** — ценностно-философское ядро и убеждения
2. **Ethos** — характер, тон, эмоциональная манера
3. **Lexicon/Style** — словарь, ключевые фразы, структура речи, ритм
4. **Topics** — предпочтительные темы и тематические границы
5. **Faith/Worldview Alignment** — вектор принципов и согласованности с credo
6. **Память** — долговременная смысловая база (embeddings) + история развития
7. **Динамика развития** — метрики «здоровья», рефлексия, адаптация под аудиторию **без потери ядра**

Система должна:

* создавать личности из источников (тексты/ссылки/видео) и пользовательского уточнения;
* «оживлять» личности через жизненный цикл (метрики, рефлексия, версии);
* выпускать контент от имени личности в соцсети;
* собирать обратную связь и превращать её в **инсайты и конкретные рекомендации** через EIDOS;
* визуализировать всё в Dashboard, который также является **графической платформой создания/редактирования личностей**.

---

## 2) Цели проекта

1. Генерация неограниченного числа уникальных личностей и их версионирование.
2. Управление «жизнью» личности: состояние, рост, целостность, рефлексия.
3. Контент-производство и публикация в соцсетях от имени выбранной личности.
4. Аналитика эффективности и самообучение рекомендаций (Feedback Loop).
5. Единый Dashboard: мониторинг + управление + конструктор личностей (визуальная граф-платформа).
6. Self-hosted инфраструктура с минимальными затратами (платные только LLM-API).

---

## 3) Термины и сущности

* **Persona (Личность):** набор структур (credo/ethos/style/topics), параметров и памяти.
* **EIDOS:** встроенный ИИ-аналитик (LLM-слой), который интерпретирует данные, ищет закономерности и формирует рекомендации, а также инициирует рефлексию.
* **Reflection Session:** диалог EIDOS ↔ пользователь для уточнения/корректировки credo и принципов.
* **Vector Store (Qdrant):** долговременная смысловая память, embeddings для источников, credo, постов и предпочтений.
* **Social Post:** единица контента (draft/published) со статистикой и сентиментом.
* **Recommendation:** actionable-совет с ожидаемым эффектом и последующей оценкой успеха.
* **Genesis Engine:** поток «рождения личности» (сбор источников → извлечение смыслов → согласование → сборка файлов → экспорт в память и workflow).

---

## 4) Область применения и основные сценарии

### 4.1. Сценарии пользователя (MVP → расширение)

1. Создать личность из «источника вдохновения» (автор/мировоззрение) или корпуса материалов.
2. Утвердить/отредактировать credo/ethos/style через диалог (Human Review).
3. Сгенерировать пост от имени личности, утвердить и опубликовать в выбранную платформу.
4. Получить аналитику эффективности постов и **конкретные рекомендации** («сделай X, ожидаемый прирост Y»).
5. Запустить Life Flow и пройти Reflection Session при снижении целостности.
6. В Dashboard сравнить личности, увидеть рост, применить рекомендации, оценить результат.
7. В Dashboard визуально «собрать» личность из блоков (граф-конструктор), создать шаблон и клонировать.

---

## 5) Архитектура высокого уровня

**Логическая схема:**

1. **Persona Generator / Genesis Engine** — создание и инициализация личности
2. **Persona Life** — жизненный цикл и развитие
3. **Social Publisher** — создание и публикация контента
4. **Analytics Dashboard + EIDOS** — аналитика, рекомендации, самообучение + UI

**Данные и инфраструктура:**

* **Supabase (PostgreSQL)** — основная БД + Auth + Realtime
* **Qdrant** — Vector Store (память/embeddings)
* **n8n self-hosted** — оркестрация потоков (flows)
* **Dashboard API** — FastAPI или NestJS (шлюз между UI и БД/flows)
* **Dashboard UI** — Next.js + Tailwind + ECharts (допустим Streamlit как альтернативный режим)
* **LLM Engine** — GPT-5 / Claude (EIDOS и генераторы)

---

## 6) Компоненты инфраструктуры (обязательно)

1. **n8n** — orchestration flows, cron, webhooks, интеграции соцсетей
2. **Supabase** — хранение сущностей, авторизация, realtime-события
3. **Qdrant** — коллекции embeddings (источники, credo, посты, предпочтения)
4. **LLM Engine** — генерация/анализ/рекомендации/диалоги
5. **Dashboard API** — единая точка доступа для UI, безопасность, бизнес-правила
6. **Dashboard UI** — визуализация, управление, чат с EIDOS, конструктор личностей
7. **Security Layer** — JWT, SSL/TLS, управление ключами соцсетей, аудит действий

---

## 7) Функциональные требования по модулям

# 7.1. Модуль 1 — Persona Generator + Persona Genesis Engine

## 7.1.1. Цель

Создать осмысленную цифровую личность, основанную на источниках, с ядром (credo/ethos/style/topics), памятью (embeddings) и готовыми артефактами для использования в других потоках.

## 7.1.2. Поток данных (минимальный)

**User → n8n Trigger/Webhook → LLM → Supabase + Qdrant → Persona Card**

## 7.1.3. Требования к входам

Поддерживаемые источники:

* файлы: **txt/pdf/docx**
* ссылки (HTTP)
* видео (YouTube) через извлечение субтитров (Transcript API)
* ручной ввод «вдохновляющего источника» (например: Тим Келлер / Достоевский / Ф. Шеффер)

## 7.1.4. Требования к извлечению и формированию личности

LLM-анализ должен сформировать структуру личности:

* `credo` — философская и ценностная база
* `ethos` — характер, эмоциональный тон
* `lexicon` / `language_profile` — ключевые фразы, словарь, структура речи
* `topics` — предпочтительные темы
* `theo_logic` / `logic` — принципы рассуждения (если применимо)
* `faith_alignment_vector` — вектор принципов/согласованности (числовой массив)
* `style` — описание речи и ритма
* `metadata_origin` — ссылки/идентификаторы источников

**Ограничение:** система должна уметь строить смысловую модель **без копирования длинных цитат** из источников (допускается использование кратких смысловых конспектов/перефраза).

## 7.1.5. Сохранение и индексация

* Сохранить запись личности в **Supabase: `personas`**
* Сгенерировать embeddings (ядро + концепты + источники) и сохранить в **Qdrant** (коллекции по типу данных)
* Создать «Persona Card» для UI (краткая карточка: имя, версия, стиль, темы, health-summary)

## 7.1.6. Версионирование (обязательно)

* Каждая личность имеет `version` и историю изменений (changelog).
* Утверждение пользователем фиксируется как **commit**: `alexey_core_vX`.
* Любое изменение credo/ethos/style создаёт новую версию, сохраняется дифф и причина.

## 7.1.7. Genesis Engine (расширенный поток рождения личности)

**Цель:** из набора источников и диалога с автором получить полный комплект артефактов:

* Vector Store (embeddings)
* Набор файлов личности (Credo/Ethos/Theo-Logic/Tone/Style)
* JSON-архитектуру и техописание интеграции
* Документацию «Как использовать личность»

### Этапы Genesis Engine (обязательно)

1. **Source Collector**

   * получает документы/ссылки/видео
   * сохраняет в `/sources/<persona_name>/`
   * конвертирует в текст → `/temp_corpus/`

2. **Content Analyzer**

   * извлекает темы, добродетели, эмоциональные тона, повторяющиеся идеи
   * кластеризует близкие концепты
   * результат: `concepts.json`
     Пример:

   ```json
   {"themes":["смысл","страдание","любовь"],"virtues":["смирение","ясность"],"tone":"утешающий"}
   ```

3. **Dialogue Generator (Human Review Loop)**

   * формирует черновик структуры личности
   * задаёт уточняющие вопросы
   * повторяется до `confirm:true`

4. **Persona Architect**

   * собирает финальные: `credo.json`, `ethos.json`, `theologic.txt`, `tone_profile.json`, `style.json`
   * формирует сводный `persona_core.json`

5. **Exporter**

   * создаёт структуру каталогов
   * создаёт Vector Store (embeddings)
   * формирует `usage_prompt.txt`, `technical_spec.json`, `readme.md`, `changelog.json`

### Итоговая структура файлов (обязательно)

```
/personas/<Name>/
  /core/
    credo.json
    ethos.json
    theologic.txt
    tone_profile.json
    style.json
    persona_core.json
  /memory/
    concepts.json
    vectorstore.db (или ссылка/идентификатор Qdrant коллекции)
  /docs/
    readme.md
    technical_spec.json
    usage_prompt.txt
    changelog.json
/sources/<Name>/...
```

## 7.1.8. Архитектура n8n-нод (обязательно, базовый шаблон)

1. Document Loader — импорт источников
2. Text Cleaner — очистка/разбиение
3. AI Embeddings — создание векторов
4. Concept Extractor — выделение ключевых идей
5. Idea Clustering — группировка Credo/Ethos/Theo-Logic
6. Architecture Builder — черновой JSON личности
7. Prompt Generator — читабельный диалог-промпт
8. Human Review (Webhook/Telegram) — правки/утверждение
9. Version Committer — сохранение версии ядра
10. Persona Synthesizer — генерация финальных файлов и регистрация в системе

## 7.1.9. Шаблоны и клонирование личностей

* Возможность создавать `architecture_template.json` на основе утверждённой личности и рождать новые личности заменой корпуса источников.
* В UI и API должна быть операция: **Create Persona from Template**.

---

# 7.2. Модуль 2 — Persona Life (жизненный цикл и развитие)

## 7.2.1. Цель

Отслеживать внутреннее состояние, динамику, «здоровье» личности и инициировать рефлексию/корректировку credo на основе метрик и обратной связи.

## 7.2.2. Поток данных

**Cron → Metrics Collector → Supabase Update → Reflection Trigger → EIDOS Dialogue**

## 7.2.3. Метрики личности (обязательно)

* **Empathy** (0–10)
* **Clarity** (0–10)
* **Faith Integrity** (0–10) — согласованность действий/контента с credo
* **Growth Momentum** (0–10)
* **Reflection Index** (0–1) — частота осмыслений/корректировок credo
* **Health Score** = `0.4*Empathy + 0.3*Clarity + 0.3*FaithIntegrity`

## 7.2.4. Поведение и триггеры

* **Life Flow** запускается каждые **7 дней** (минимум)
* Изменения записываются в `metrics_history`
* Если **Faith Integrity снизилась > 10%** за период → автоматически инициировать **Reflection Session**

## 7.2.5. Reflection Session (обязательно)

Формат: диалог EIDOS ↔ пользователь с вопросами:

* «Какие события могли повлиять на внутреннее состояние личности?»
* «Изменилось ли credo?»
* «Что можно добавить или уточнить?»

Результат:

* сохраняется в таблицу `reflections`
* при изменении ядра личности создаётся новая версия `persona_core_vX` и обновляются embeddings в Qdrant

---

# 7.3. Модуль 3 — Social Publisher (создание и публикация контента)

## 7.3.1. Цель

Формировать и публиковать контент от имени выбранной личности с учётом её credo/style/topics и рекомендаций EIDOS.

## 7.3.2. Поток данных

**Trigger → LLM Post Generator → Draft/Review → Publish API → Social Data Feedback**

## 7.3.3. Этапы (обязательно)

1. Выбор `persona_id`
2. Получение рекомендаций из `recommendations` (актуальные)
3. Генерация текста поста через LLM с учётом:

   * credo/ethos/style/lexicon
   * текущих целей личности
   * аудитории и платформы
4. (Опционально) генерация визуалов через DALL·E/Midjourney API
5. Публикация через HTTP-интеграции:

   * Telegram Bot API
   * Instagram Graph API
   * TikTok Business API
6. Сбор статистики:

   * reactions/likes/comments/shares/reach
   * sentiment (позитив/негатив/нейтр.)
     → запись в `social_posts`

## 7.3.4. Черновики и статусы

* `draft` → `review` → `published` → `archived`
* Публикация возможна **только после approval** (Human Review), если включён режим модерации.

Пример draft:

```json
{
  "persona_id":"alexey-uuid",
  "topic":"надежда в повседневности",
  "tone":"вдохновляющий",
  "format":"текст",
  "content":"Иногда вера растёт не от чудес, а от тишины...",
  "platform":"instagram",
  "status":"draft"
}
```

---

# 7.4. Модуль 4 — Analytics Dashboard + EIDOS (аналитика, обучение, рекомендации)

## 7.4.1. Цель

Дать глубокий анализ развития личностей и эффективности контента: не только графики, но **закономерности + рекомендации + оценка результата**.

## 7.4.2. Структура EIDOS Engine (обязательно)

1. **Data Processor** — сбор/нормализация данных
2. **Insight Engine** — выявление закономерностей (темы, тон, форматы, аудитории)
3. **Recommendation Engine** — генерация actionable-советов с ожидаемым эффектом
4. **Feedback Evaluator** — оценка успеха рекомендаций по фактическим данным

## 7.4.3. Источники данных

* Supabase `social_posts` — статистика контента
* Supabase `metrics` + `metrics_history` — состояние личности
* Qdrant — векторы credo, постов, концептов, предпочтений
* LLM интерпретация — смысловой анализ

## 7.4.4. Метрики эффективности (обязательно)

* **Engagement Rate** = (likes + comments + shares) / reach
* **Sentiment Index** = (positive − negative) / total
* **Faith Alignment** = cosine(credo_embedding, post_embedding)
* **Tone Efficiency** = avg(engagement_rate by tone)
* **Topic Growth** = Δ engagement by topic

## 7.4.5. Инсайты и рекомендации (формат результата)

EIDOS должен возвращать структурированный JSON:

```json
{
  "persona":"Alexey",
  "period":"2025-12-01→2025-12-10",
  "insights":[
    {"topic":"вера","effectiveness":"+18%"},
    {"tone":"вдохновляющий","effectiveness":"+12%"},
    {"format":"короткие тексты","effectiveness":"+35%"}
  ],
  "recommendations":[
    {"action":"Создать серию постов о надежде","expected_gain":"+22%"},
    {"action":"Снизить рациональный тон","expected_gain":"+10%"}
  ]
}
```

## 7.4.6. Feedback Loop (самообучение)

1. Пользователь применяет рекомендации (пометка/связь постов с рекомендацией).
2. Через неделю (или заданный период) обновляются данные Social Flow.
3. EIDOS сравнивает прогноз и факт (например: engagement ↑ 20%, Faith Integrity ↑ 0.5).
4. Рекомендации получают статус:

   * `successful` / `neutral` / `failed`
   * пересчитывается «вес» рекомендаций и предпочтений личности
5. Обновляется модель предпочтений личности в Qdrant.

---

## 8) Требования к Dashboard UI (мониторинг + управление + EIDOS Chat)

### 8.1. Разделы интерфейса (обязательно)

1. **Overview** — список всех личностей + краткая статистика
2. **Persona Detail** — графики Empathy/Clarity/FaithIntegrity/Growth/Health Score
3. **Content Intelligence** — анализ постов, heatmap тонов, темы, форматы
4. **EIDOS Chat** — чат с аналитиком (запросы/объяснения/планы)
5. **Reports** — история рекомендаций и их успеха
6. **Comparisons** — сравнение личностей (матрицы/рейтинги/корреляции)

### 8.2. Ключевые функции Dashboard (обязательно)

* сравнение личностей между собой
* фильтры по периоду/платформе/теме/тону/формату
* графики вовлечённости и духовной целостности
* кнопка **«Рекомендовать пост»** → генерация нового контента на основе анализа

---

## 9) Дополнительное требование: Dashboard как графическая платформа создания личностей

Dashboard должен быть не только витриной метрик, но и **конструктором личностей (Persona Builder)** в формате визуального графа/платформы.

### 9.1. Persona Builder — ключевые возможности (обязательно)

1. **Wizard + Graph Mode**

   * Wizard: пошаговое создание (Источники → Концепты → Credo/Ethos → Style → Preview → Confirm)
   * Graph Mode: визуальная сборка блоков личности (узлы и связи)

2. **Визуальные сущности (узлы)**

   * Source Node (файл/ссылка/видео)
   * Concept Cluster Node (темы/добродетели/принципы)
   * Credo Node (утверждения, приоритеты)
   * Ethos Node (добродетели, тон, характер)
   * Theo-Logic Node (принципы рассуждения)
   * Lexicon/Style Node (словарь, паттерны речи)
   * Guardrails Node (ограничения, запреты, этика)
   * Memory Node (Qdrant коллекции/пространства)
   * Output Node (persona_core.json, usage_prompt)

3. **Drag-and-Drop редактирование**

   * добавление/удаление блоков
   * связывание блоков (например, Credo → Guardrails → Post Generator)
   * изменение веса/приоритета утверждений credo
   * inline-редактор формулировок + кнопка «переформулировать в стиле личности»

4. **Human Approval & Version Commit прямо из UI**

   * предпросмотр persona_core.json и человеко-читаемого описания
   * комментарии и правки
   * подтверждение → создание версии + экспорт

5. **Template System**

   * сохранить «архитектуру личности» как шаблон
   * создать новую личность из шаблона, заменив источники
   * библиотека шаблонов (локальная)

6. **Встроенный просмотр «папки личности»**

   * core/memory/docs
   * changelog версий
   * кнопка «Export» (архив/ссылка/регистрация)

7. **Интеграция с n8n**

   * визуальный статус потоков Genesis/Life/Social
   * запуск flows из UI
   * журнал выполнения (run history) и ошибки

### 9.2. Обязательные UI-экраны Persona Builder

* Library (список личностей + шаблоны)
* Persona Canvas (граф-редактор)
* Source Manager (загрузка/подключение)
* Concepts & Clusters (таблица + визуальная кластер-карта)
* Core Editor (Credo/Ethos/Style)
* Preview & Simulation (пример ответов личности на 3–5 тест-вопросов)
* Versioning (версии, диффы, причины изменений)

---

## 10) Модель данных (Supabase) — обязательные таблицы

1. `personas` — основные данные личности
2. `persona_versions` — версии ядра (ссылки на файлы/JSON, diff, reason)
3. `metrics` — текущие метрики личности
4. `metrics_history` — история метрик
5. `reflections` — результаты Reflection Sessions
6. `social_posts` — посты, статусы, статистика, embeddings refs
7. `recommendations` — советы EIDOS + expected_gain + status + link_to_posts
8. `analyst_reports` — отчёты/пакеты инсайтов EIDOS
9. `sources` — источники личности (метаданные, пути, типы)
10. `audit_log` — лог действий (пользователь, EIDOS, flows, API)

---

## 11) Vector Store (Qdrant) — обязательные коллекции/типы

* `persona_sources_embeddings` — embeddings источников
* `persona_core_embeddings` — embeddings credo/ethos/style
* `social_post_embeddings` — embeddings постов
* `persona_preference_embeddings` — предпочтения/обучение рекомендаций

---

## 12) Интеграции и API (Dashboard API)

### 12.1. Аутентификация

* JWT (Supabase Auth)
* Все endpoints требуют авторизации, кроме health-check

### 12.2. Обязательные endpoints (минимум)

| Endpoint                   | Метод | Назначение                            |
| -------------------------- | ----: | ------------------------------------- |
| `/personas`                |  POST | создание личности (инициация Genesis) |
| `/personas/:id`            |   GET | данные личности                       |
| `/personas/:id/versions`   |   GET | список версий                         |
| `/personas/:id/versions`   |  POST | commit новой версии (после approval)  |
| `/personas/:id/sources`    |  POST | добавить источники                    |
| `/personas/:id/export`     |  POST | экспорт «папки личности»              |
| `/metrics`                 |  POST | обновление метрик                     |
| `/social/draft`            |  POST | создание черновика                    |
| `/social`                  |  POST | запись/обновление поста и статистики  |
| `/analyst/query`           |  POST | вопрос к EIDOS                        |
| `/analyst/recommendations` |  POST | запрос новых рекомендаций             |
| `/feedback`                |  POST | отметка успеха рекомендации           |
| `/flows/run`               |  POST | запуск n8n flow (Genesis/Life/Social) |
| `/flows/status`            |   GET | статусы последних прогонов            |

---

## 13) Безопасность (обязательно)

1. JWT-аутентификация
2. HTTPS (через Nginx proxy)
3. Ограничение и защита ключей соцсетей (env/secrets)
4. Аудит-логирование всех действий EIDOS и flows
5. Разделение ролей (минимум): admin / editor / viewer
6. Rate limiting на LLM-эндпоинты и publish-операции

---

## 14) Логирование и наблюдаемость

* Логи n8n runs: входные параметры, статус, время выполнения, ошибка
* Логи EIDOS: запрос → вывод → использованные источники/метрики → записанный результат
* Метрики производительности API (latency, error rate)
* Хранение audit trail минимум N дней (настройка)

---

## 15) Инфраструктура и развёртывание (Docker)

Минимальный docker-набор (как в описании, допускается расширение):

```yaml
version: '3.8'
services:
  n8n:
    image: n8nio/n8n
    ports: ["5678:5678"]

  postgres:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: example

  supabase:
    image: supabase/realtime
    depends_on: [postgres]

  qdrant:
    image: qdrant/qdrant
    ports: ["6333:6333"]

  dashboard-api:
    build: ./api
    ports: ["3050:3050"]

  dashboard-ui:
    build: ./ui
    ports: ["3051:3051"]
```

---

## 16) Нефункциональные требования

1. Масштабируемость: сотни персон при общем ядре EIDOS
2. Скорость анализа: **< 3 сек на запрос** (цель)
3. Частота обновления: минимум 1 раз в сутки (общесистемно) и Life Flow раз в 7 дней
4. Надёжность: повторяемые flow-запуски, retry-механизмы, idempotency для публикаций
5. Модульность: каждый блок можно использовать независимо
6. Минимальные затраты: self-hosted; внешние расходы — LLM API + соцсети APIs (если платные)

---

## 17) Метрики системы (KPI)

* Количество личностей: ∞
* Средняя частота обновления: 1/сутки (или выше)
* Скорость анализа: < 3 сек на запрос (цель)
* Средний отклик пользователя: 70–90% (цель)
* «Рентабельность» (ориентир): $20/мес при полной автономности (как целевой ориентир эксплуатации)

---

## 18) Критерии приёмки (Acceptance Criteria)

### 18.1. Persona Generator / Genesis Engine

* Можно создать личность из источника и/или корпуса файлов/видео.
* Есть Human Review: пользователь утверждает ядро, создаётся версия v1.
* В Supabase есть запись `personas`, в Qdrant — embeddings, в docs/core — артефакты.
* Можно создать новую личность из template.

### 18.2. Persona Life

* Life Flow запускается по расписанию.
* Метрики обновляются, пишутся в history.
* При падении Faith Integrity > 10% стартует Reflection Session и результат сохраняется.

### 18.3. Social Publisher

* Создаётся draft, проходит review, публикуется в выбранную платформу.
* Статистика возвращается и сохраняется в `social_posts`.

### 18.4. Analytics + EIDOS

* EIDOS выдаёт инсайты и **конкретные** рекомендации с expected_gain.
* Работает feedback-оценка рекомендаций (успешно/неуспешно) и обновление «весов».

### 18.5. Dashboard как Persona Builder

* В UI есть Canvas/Graph-режим сборки личности из блоков.
* Можно загрузить источники, увидеть концепты/кластеры, отредактировать credo/ethos/style.
* Можно подтвердить и закоммитить версию, экспортировать артефакты, запустить flows.

---

## 19) Итог результата реализации (ожидаемый эффект)

MPIS после развёртывания обеспечивает:

1. генерацию неограниченного числа уникальных личностей;
2. их развитие и самоосмысление (метрики + рефлексия + версии);
3. создание и публикацию контента;
4. аналитический контур EIDOS: закономерности → рекомендации → измерение результата;
5. единый визуальный контроль и управление, включая **графическую платформу создания личностей**.

