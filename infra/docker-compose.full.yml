# MPIS Full Stack - Docker Compose
# 
# This file deploys all MPIS modules in a single stack.
#
# Prerequisites:
# - External network 'mpis_net' must exist
# - mpis-postgres and mpis-qdrant containers must be running on mpis_net
# - Run all database migrations (002_genesis.sql, 003_life.sql, 004_publisher.sql, 005_analytics.sql)
#
# Usage:
# 1. Copy api/.env.example to /opt/mpis/infra/.env and configure
# 2. Run: docker compose -f docker-compose.full.yml up -d

version: '3.8'

services:
  # Module 1: Genesis API (port 8080)
  genesis-api:
    build:
      context: ../api
      dockerfile: Dockerfile
    container_name: genesis-api
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql+asyncpg://mpis:mpis@mpis-postgres:5432/mpis}
      - QDRANT_URL=${QDRANT_URL:-http://mpis-qdrant:6333}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LLM_MODEL=${LLM_MODEL:-gpt-4-turbo-preview}
      - DRY_RUN=${DRY_RUN:-false}
      - DEBUG=${DEBUG:-false}
      - YOUTUBE_LINKS_DIR=/opt/mpis/input
      - PERSONAS_BASE_DIR=/opt/mpis/personas
      - SOURCES_BASE_DIR=/opt/mpis/sources
      - GDRIVE_SERVICE_ACCOUNT_JSON_PATH=/opt/mpis/secrets/gdrive_sa.json
      - API_PORT=8080
    volumes:
      - /opt/mpis/input:/opt/mpis/input:ro
      - /opt/mpis/personas:/opt/mpis/personas
      - /opt/mpis/sources:/opt/mpis/sources
      - /opt/mpis/secrets:/opt/mpis/secrets:ro
    ports:
      - "127.0.0.1:8080:8080"
    networks:
      - mpis_net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.mpis.service=genesis-api"
      - "com.mpis.module=1"

  # Note: All modules share the same codebase.
  # In the full stack, all endpoints are available on a single instance.
  # The separate compose files are for running modules independently if needed.

networks:
  mpis_net:
    external: true
