# MPIS Genesis API - Docker Compose Snippet
# 
# This file should be merged with /opt/mpis/infra/docker-compose.yml
# to add the genesis-api service.
#
# Prerequisites:
# - External network 'mpis_net' must exist
# - mpis-postgres and mpis-qdrant containers must be running on mpis_net
#
# Usage:
# 1. Copy this content to /opt/mpis/infra/docker-compose.yml (or merge)
# 2. Copy api/.env.example to /opt/mpis/infra/.env and configure
# 3. Run: docker compose up -d genesis-api

version: '3.8'

services:
  genesis-api:
    build:
      context: ../api
      dockerfile: Dockerfile
    container_name: genesis-api
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql+asyncpg://mpis:mpis@mpis-postgres:5432/mpis}
      - QDRANT_URL=${QDRANT_URL:-http://mpis-qdrant:6333}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LLM_MODEL=${LLM_MODEL:-gpt-4-turbo-preview}
      - DRY_RUN=${DRY_RUN:-false}
      - DEBUG=${DEBUG:-false}
      - YOUTUBE_LINKS_DIR=/opt/mpis/input
      - PERSONAS_BASE_DIR=/opt/mpis/personas
      - SOURCES_BASE_DIR=/opt/mpis/sources
      - GDRIVE_SERVICE_ACCOUNT_JSON_PATH=/opt/mpis/secrets/gdrive_sa.json
    volumes:
      # Mount directories for file access
      - /opt/mpis/input:/opt/mpis/input:ro
      - /opt/mpis/personas:/opt/mpis/personas
      - /opt/mpis/sources:/opt/mpis/sources
      - /opt/mpis/secrets:/opt/mpis/secrets:ro
    ports:
      # API exposed on port 8080
      # Use 127.0.0.1:8080 to restrict to localhost only
      # Use 0.0.0.0:8080 to expose publicly
      - "127.0.0.1:8080:8080"
    networks:
      - mpis_net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.mpis.service=genesis-api"
      - "com.mpis.module=1"

networks:
  mpis_net:
    external: true
